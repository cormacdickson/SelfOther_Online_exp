<!DOCTYPE html>
<html>
  <head>
  	<meta charset="UTF-8">
    <title>Social Experiment 6.3</title>
    <script src="jspsych-6.3.0/jspsych.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-rdk.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-training-pretrial.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-training-trial.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-training-fb.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-fb-sequence.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-decision.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-fb.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-training-fb.js"></script>
    <script src="training_schedule.js"></script>
    <script src="main_trial_schedule.js"></script>
    <script src="Porder.js"></script>
    <link href="jspsych-6.3.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <link href="style.css" rel="stylesheet" type="text/css" />
  	</head>

  	<body>

  	</body>
  	<script>

    // hardcode important Variables
    var subject_id = 1;




     /* CREATE TIMELINE */
    var timeline = [];
/*
    function getFileName(fileExtension) {
        var nowMilli = Date.now();
        return "blob" + nowMilli + "." + fileExtension;
*/
    var enter_fullscreen = {
      type: "fullscreen",
      fullscreen_mode: true
    }
    // timeline.push(enter_fullscreen)

    var instructions = {
           type: 'instructions',
           pages: function() {return [
               '<h1>Welcome to the group competition game!</h1>'+

               '<p>This game is about working together with another person in a team. Your team is playing against another team of two people. To Identify you, we will ask you to enter your initials on the next screen.</p>'+

               '<p>The game will take about 30 minutes and has two parts:</p>'+

               '<p>- Part 1: Individual performance assessment(~5min) </br> -Part 2: The group competition task<p>'+

               '<p>Press the arrow to procee to the next screen and enter you initials.</p>'

           ]},
           show_clickable_nav: true,
           button_label_previous: '',
           button_label_next: ''
       }

// timeline.push(instructions)





var get_initials = {
  type: "survey-text",
  questions: [ {prompt: 'Please enter your initials in the box below:', required: true}],
  on_finish: function(data) {
        initials = data.response.Q0.toUpperCase();
        jsPsych.data.addProperties({ player: initials });
        return initials;
    }
}

var confirm_initials = {
  type: "survey-multi-choice",
  questions: [{
      prompt: function() {
        //var playerid   = jsPsych.data.getDataByTimelineNode('0.0-0.0').select('player').values[0];
        var playerid   = jsPsych.data.get().select('player').values[0];
        return 'Please confirm your initials are: ' +playerid+ '';
      },
      name: 'confirmInitials',
      options: ['Confirm', 'Re-enter initals'],
      required: true
  }],
};

var Get_ID_loop = {
    timeline: [get_initials,confirm_initials],
    loop_function: function(){
        var data = jsPsych.data.get().last(1).values()[0];
        if(jsPsych.pluginAPI.compareKeys(data.response.confirmInitials, 'Confirm')){
            return false;
        } else {
            return true;
        }
    }
}

timeline.push(Get_ID_loop);




var instructions_2 = {
           type: 'instructions',
           pages: function() {return [


               '<p>First of all this is how we will display the two teams on screen:.</p>'+

               '<p><img src="images/intro_inst.png" width="250px" class="center"></p>'+

               '<p>(Note: the abbreviations will be shown on this task).<p>'+

               '<p>Press the arrow buttons to proceed to the next screen.<p>',



               '<h1>Part 1 - Individual performance assessment: Random dot motion task!</h1>'+

               '<p>We ask you to perform a “random dot motion” task, in which you will see dot motion clouds moving to the left or to the right at your position where your initials are.<p>'+

               '<p>Please press the “left” or “right” arrow button to indicate the correct direction.<p>'+

              '<p>Correct performance will be displayed as:</br><img src="images/fb_correct.png" width="100px" class="center"><p>'+

              '<p>Incorrect performance will be displayed as:</br><img src="images/fb_wrong.png" width="150px" class="center"><p>'+

              '<p>Note that you will have to respond very quickly after the dots have appeared, otherwise your performance will be counted as incorrect.<p>'+

              '<p>We will collect your peformance information when you do so.<p>'+

              '<p>Try it now! Press the right arrow to start.</p>'


           ]},
           show_clickable_nav: true,
           button_label_previous: '',
           button_label_next: ''
       }

// timeline.push(instructions_2)
var training_pretrial = {
  // get the subjects initials
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
    return ;
  },
    type:"training-pretrial",
    trial_duration: 1500,
    RDK_type: 3, //Applied to all apertures if only one value
    player_position: [0,1,2,3],
    aperture_width: 200, //Applied to all apertures if only one value
    border: true,
    background_color: 'grey',
    border_color: ["white","blue","black","purple"],
    aperture_center_x: [(window.innerWidth/2-window.innerWidth/5), //topleft
                        (window.innerWidth/2+window.innerWidth/5), //topright
                        (window.innerWidth/2+window.innerWidth/5),
                        (window.innerWidth/2-window.innerWidth/5)],
    aperture_center_y: [(window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4)
                      ]
};



  var training_trial = {
    type:"training-trial",
    trial_duration: 1000,
    correct_choice: jsPsych.timelineVariable('correct_ans'),
    coherent_direction: jsPsych.timelineVariable('coh_D'),
    coherence: jsPsych.timelineVariable('coh'),
    RDK_type: 3, //Applied to all apertures if only one value
    aperture_type: 1, // circle
    player_on:0, // index of the player to show rdk for [self,partner,op1,op2]
    player_position: [0,1,2,3],
    aperture_width: 200, //Applied to all apertures if only one value
    border: true,
    //move_distance: [0,0,0,0],
    player_colours: ["white","blue","green","purple"],
    number_of_dots: [50,50,50,50], //Different parameter for each aperture. Array length must equal number_of_apertures
    aperture_center_x: [(window.innerWidth/2-window.innerWidth/5), //topleft
                        (window.innerWidth/2+window.innerWidth/5), //topright
                        (window.innerWidth/2+window.innerWidth/5),
                        (window.innerWidth/2-window.innerWidth/5)],
    aperture_center_y: [(window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4)
                      ]
                      /*
    on_finish: function(data){
      // Score the response as correct or incorrect.
      if(jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)){
        data.correct = true;
      } else {
        data.correct = false;
      }
    }
    */
};


var training_fb = {
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
  },

    type:"training-fb",
    number_of_apertures: 4, //This needs to be set if more than one aperture
    trial_duration: 500,
    RDK_type: 3, //Applied to all apertures if only one value
    player_position: [0,1,2,3],
    aperture_type: 1, // circle
    aperture_width: 200, //Applied to all apertures if only one value
    border: true,
    feedback: function(){
      var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
      if(last_trial_correct){
        return 1;
      } else {
        return 0
      }
    },
    background_color: 'grey',
    border_color: ["white","blue","black","purple"],
    aperture_center_x: [(window.innerWidth/2-window.innerWidth/5), //topleft
                        (window.innerWidth/2+window.innerWidth/5), //topright
                        (window.innerWidth/2+window.innerWidth/5),
                        (window.innerWidth/2-window.innerWidth/5)],
    aperture_center_y: [(window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4)
                      ]
};


var training_block = {
  timeline: [training_pretrial, training_trial,training_fb],
  timeline_variables: training_schedule,
  timeline_variables:main_trial_schedule,
  randomize_order:false
}


 //timeline.push(training_block)


//---------------------------------------------
///------------ Training Ends ------------///
//----------------------------------------------


//---------------------------------------------
///------------ Main exp begins ------------///
//----------------------------------------------

var trial = {
    type: "rdk",
    post_trial_gap: 0,
    number_of_dots: 200,
    RDK_type: 3,
    choices: ["a", "l"],
    correct_choice: "a",
    coherent_direction: 180,
    trial_duration: 1000
};
//timeline.push(trial)


var main_fb_sequence = {
  type:"main-fb-sequence",
  //trial_duration: 10000,
  trial_duration: [300,100,200,100,200,100,200,100,200,100,200,100,200,500],
  coherent_direction: 0,
  S_perf : jsPsych.timelineVariable('S_perf'),//[0,1,0,1,0,1],
  P_perf : jsPsych.timelineVariable('P_perf'),//[0,1,0,1,0,1],
  O1_perf : jsPsych.timelineVariable('O1_perf'),//[0,1,0,1,0,1],
  O2_perf : jsPsych.timelineVariable('O2_perf'),//[0,1,0,1,0,1],
  coherence: 0.5,
  p_order: jsPsych.timelineVariable('Porder'),//[0,1,2,3], // index of the player to show rdk for [self,partner,op1,op2]
  aperture_width: 200, //Applied to all apertures if only one value
  border: true,
  player_colours: ["white","blue","green","purple"],
  number_of_dots: [50,50,50,50], //Different parameter for each aperture. Array length must equal number_of_apertures
  aperture_center_x: [(window.innerWidth/2-window.innerWidth/5), //topleft
                      (window.innerWidth/2+window.innerWidth/5), //topright
                      (window.innerWidth/2+window.innerWidth/5),
                      (window.innerWidth/2-window.innerWidth/5)],
  aperture_center_y: [(window.innerHeight/2-window.innerHeight/4),
                      (window.innerHeight/2-window.innerHeight/4),
                      (window.innerHeight/2+window.innerHeight/4),
                      (window.innerHeight/2+window.innerHeight/4)
                    ]
};

var Porder_schedule = "Porder_"+subject_id;



// create the main decision trial
var main_decision_1 = {
  // get the subjects initials
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
    return ;
  },
    type:"main-decision",
    dec_num: 0, // first or second decison
    dectype: jsPsych.timelineVariable('dectype'),
    outcomeEngage: jsPsych.timelineVariable('outcomeEngage'),
    trial_duration: 3000,
    response_ends_trial: true,
    choices: ["arrowleft","arrowright"],

    RDK_type: 3, //Applied to all apertures if only one value
    player_position: [0,1,2,3],
    aperture_width: 200, //Applied to all apertures if only one value
    border: true,
    background_color: 'grey',
    border_color: ["white","blue","black","purple"],
    aperture_center_x: [(window.innerWidth/2-window.innerWidth/5), //topleft
                        (window.innerWidth/2+window.innerWidth/5), //topright
                        (window.innerWidth/2+window.innerWidth/5),
                        (window.innerWidth/2-window.innerWidth/5)],
    aperture_center_y: [(window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4)
                      ]
};

var main_decision_2 = {
  // get the subjects initials
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
    return ;
  },
    type:"main-decision",
    dec_num: 1, // first or second decison
    dectype: jsPsych.timelineVariable('dectype'),
    outcomeEngage: jsPsych.timelineVariable('outcomeEngage'),
    trial_duration: 3000,
    response_ends_trial: true,
    choices: ["arrowleft","arrowright"],

    RDK_type: 3, //Applied to all apertures if only one value
    player_position: [0,1,2,3],
    aperture_width: 200, //Applied to all apertures if only one value
    border: true,
    background_color: 'grey',
    border_color: ["white","blue","black","purple"],
    aperture_center_x: [(window.innerWidth/2-window.innerWidth/5), //topleft
                        (window.innerWidth/2+window.innerWidth/5), //topright
                        (window.innerWidth/2+window.innerWidth/5),
                        (window.innerWidth/2-window.innerWidth/5)],
    aperture_center_y: [(window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4)
                      ]
};


var main_training_fb = {
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
  },

    type:"main-training-fb",
    number_of_apertures: 4, //This needs to be set if more than one aperture
    trial_duration: 1000,
    RDK_type: 3, //Applied to all apertures if only one value
    player_position: [0,1,2,3],
    aperture_type: 1, // circle
    aperture_width: 200, //Applied to all apertures if only one value
    border: true,
    feedback: function(){
      var last_resp = jsPsych.data.get().last(1).values()[0].response;
      if(jsPsych.pluginAPI.compareKeys(last_resp, 'arrowleft')){
        return 0;
      } else if (jsPsych.pluginAPI.compareKeys(last_resp, 'arrowright')) {
        return 1
      }
    },
    background_color: 'grey',
    border_color: ["white","blue","black","purple"],
    aperture_center_x: [(window.innerWidth/2-window.innerWidth/5), //topleft
                        (window.innerWidth/2+window.innerWidth/5), //topright
                        (window.innerWidth/2+window.innerWidth/5),
                        (window.innerWidth/2-window.innerWidth/5)],
    aperture_center_y: [(window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4)
                      ]
};



var main_fb = {
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
  },

    type:"main-fb",
    number_of_apertures: 4, //This needs to be set if more than one aperture
    trial_duration: 1000,
    RDK_type: 3, //Applied to all apertures if only one value
    player_position: [0,1,2,3],
    aperture_type: 1, // circle
    aperture_width: 200, //Applied to all apertures if only one value
    border: true,
    feedback: function(){
      var last_resp = jsPsych.data.get().last(1).values()[0].response;
      if(jsPsych.pluginAPI.compareKeys(last_resp, 'arrowleft')){
        return 0;
      } else if (jsPsych.pluginAPI.compareKeys(last_resp, 'arrowright')) {
        return 1
      }
    },
    background_color: 'grey',
    border_color: ["white","blue","black","purple"],
    aperture_center_x: [(window.innerWidth/2-window.innerWidth/5), //topleft
                        (window.innerWidth/2+window.innerWidth/5), //topright
                        (window.innerWidth/2+window.innerWidth/5),
                        (window.innerWidth/2-window.innerWidth/5)],
    aperture_center_y: [(window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2-window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4),
                        (window.innerHeight/2+window.innerHeight/4)
                      ]
};



// create timeline for the main block
var main_training_block = {
  timeline: [main_decision_1,main_training_fb],
  timeline_variables: main_trial_schedule,
  //timeline_variables: Porder, //"Porder_"+subject_id,
  randomize_order:false
}

//timeline.push(main_training_block)
var show_data = {
    type: "html-button-response",
    stimulus: function() {
      var trial_data = jsPsych.data.getLastTrialData().values();
      var trial_json = JSON.stringify(trial_data, null, 2);
      return `<p style="margin-bottom:0px;"><strong>Trial data:</strong></p>
        <pre style="margin-top:0px;text-align:left;">${trial_json}</pre>`;
    },
    choices: ['Repeat demo']
  };

// create timeline for the main block
var main_block = {
  timeline: [main_fb_sequence,main_decision_1,main_fb,main_decision_2,main_fb],
  timeline_variables: main_trial_schedule,
  //timeline_variables: Porder, //"Porder_"+subject_id,
  randomize_order:false
}

timeline.push(main_block)














/*
var main_block_a = {
  timeline: [main_trial, main_dec1,main_fb,main_dec2],  // main trial displays feedback sewquence
  timeline_variables: main_schedule_a_diff1,
  randomize_order:false
}

timeline.push(main_block_a)

*/













// jsPsych.run([enter_fullscreen]);

/*


	  var preload_trial = {
    type: 'preload',
    auto_preload: true

}

timeline.push(preload_trial)







// Instructions #1
       var instructions = {
           type: 'instructions',
           pages: function() {return [
               '<h1>Welcome!</h1>'

           ]},
           show_clickable_nav: true,
           button_label_previous: '',
           button_label_next: ''
       }

timeline.push(instructions)




// prompt for
var trial = {
  type: 'jspsych-survey-text',
  preamble: '<p>What are your intials?</p>',
  html: '<p><input type="text" id="test-resp-box" name="response" size="10" /></p>',
  autofocus: 'test-resp-box'
};

timeline.push(trial)

*/
//Instructions 2



/*
	var feedback = {
         type: 'html-keyboard-response',
         stimulus: function(){
           var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
           if(last_trial_correct){
             return "<div style=\"width:150px;height:56px;font-size:30px;text-align:center;\">Correct!</div>";
           } else {
             return "<div style=\"width:150px;height:56px;border:0px;font-size:30px;text-align:center\">Wrong.</div>"
           }
         },
         trial_duration: function(){
           var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
           if(last_trial_correct){
             return 1000;
           } else {
             return 1500
           }
         },
         response_ends_trial: false
       }



   var practice_block = {
        timeline: [buffer, discrimination_block, response_block, feedback],
        timeline_variables: practice_sequence,
        repetitions: 1,
        randomize_order: false
      }


timeline.push(practice_block);

timeline.push(debrief_block);

*/


// select all trials
// var all_data = jsPsych.data.get();

// get csv representation of data and log to console
// console.log(all_data.csv());


/* start the experiment */
//jatos.onLoad(function() {

/*
      on_finish: function() {
        //jsPsych.data.displayData('csv');
        var resultJson = jsPsych.data.get().csv();
      jatos.submitResultData(resultJson, jatos.endStudy);
      }
      */

jsPsych.init({
      timeline: timeline,
      on_finish: function() {
        jsPsych.data.displayData('csv');
    }
    });
  </script>
</html>
