<!DOCTYPE html>
<html>
  <head>
  	<meta charset="UTF-8">
    <title>Social Experiment 6.3</title>
    <script src="jspsych-6.3.0/jspsych.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-call-function.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-rdk.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-RDM-pretrial.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-RDM-trial.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-instruction.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-RDM-instruction.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-RDM-training-fb.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-RDM-fb.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-preparing-schedules.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-fb-sequence.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-decision.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-decision-training.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-fb.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-training-fb.js"></script>
    <script src="RDM_training_schedule.js"></script>
    <script src="main_trial_schedule.js"></script>
    <script src="DUMMY_main_trial_schedule.js"></script>
    <script src="main_trial_training_schedule.js"></script>
    <script src="Porder_schedule.js"></script>
    <script src="DUMMY_Porder_schedule.js"></script>
    <script src="rdmperf.js"></script>
    <link href="jspsych-6.3.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    
  	</head>

  	<body>

  	</body>
  	<script>
  	//////////////////////////////////////////
    // hardcode important Variables //////////////
    //////////////////////////////////////////

    var subject_id            			= jsPsych.randomization.randomID(7); // generat a 15 digit subjet ID
    var colours               			= ["rgb(127,201,127)","rgb(190,174,212)","rgb(253,192,134)","rgb(255,255,153)" ];
    var random_porder_index   			= Math.floor(Math.random() * 1000);   // generate a random index and use this value to access one of the porder schedules
    var this_subjects_porder  			= "DUMMY_Porder_"+random_porder_index;   // until schedule is properly created just set it to use shorter dummy schedules so its easier to debug    
    var porder_sch            			= eval(this_subjects_porder);
    var main_trial_count      			= 0; // counter used to access correct value from porder schedule
    var this_subs_schedule; // will assign to a specific schedule later
    //this_subs_schedule        			= eval("DUMMY_main_sch_1"); // until schedule is properly created just set it to sch1, this is the line to replace
    var RDM_pretrial_duration 			= 1000; // duration that the initials are displayed at the start of the exp
    var positions 			  	 		    = [0,1,2,3]; // positions of the players [topleft,bottomleft,topright,bottomright]

    var bcgnd_color 		  			    = "black";
    var player_cols 		  			    = jsPsych.randomization.repeat(colours, 1); // assign colors randomly based on the four possible
    var total_dots 			  		    	= [50,50,50,50]; //number of dots in each RDK
    var RDM_trial_duration 	  			= 1000; // duration of the rdm
    var RDktype	  			  		    = 4; // type of rdk mechanism used
    var Aperturetype 	  	  		  	= 1; // type of aperture used (1=circle)
    var Aperturenum       	  			= 4; // number of apertures
  	var RDM_training_fb_duration 		= 500; // duration that fb is displayed for during rdm task
  	var Main_fb_sequence_dur 	 	  	= [300,100,300,100,300,100,300,100,300,100,300,100,300]; // each timing corresponds to a portion of the feedback delay
  	var main_ITI  						= 500;
  	var Main_decision_duration   		= 3000; //
  	var Main_decision_choices    		= ["arrowleft","arrowright"]; //responses only registered if they are listed here
    var Main_decision_fb_dur     		= 1000;
    var Main_training_decision_fb_dur   = 2000;
    var trial_count              		= 0; // used to check if this trial is a break trial
    var borders                  		= false;
    var RDM_performance          		= 0;
    var num_RDM_training_trials         = 1; //
    var num_RDM_trials           		= 1; //
    var enough_rdm_trials 				= 0.8*(num_RDM_training_trials+num_RDM_trials);
    var num_RDM_repeat_trials    		= 5;
    var closest_sch_value;  // global variable used to store the colosest accuracy value  to match scheduels
    var closest_sch_index; // global variable to store the closest sch index
    var initials;
    var display_initials              = '40px Open sans';
    var dec_arw_display = {
    	//// variable called dec_arrow which is accesible to all arrow using plugins from socialexp_6.3
				// it has different properties which you can set and the will change for all arrows
			arrowhead_length: -1,
			arrow_body_thickness: 100,
      		arrow_head_thickness: -1,
			arrow_head_angle: -30
		};
	var fb_box_display = {
			fb_line_thick: -1,
			fb_box_wdt: -1,
      		fb_box_ht: -1,
		};
    

	// intialise variables for rdm training so wecan determine coherance direction and the corresponding correct answer
	var correct_ans_right = "arrowright";
	var correct_ans_left  = "arrowleft";
	var chosenValue;
	var total_num_dm_trials = 4;
	var total_num_blocks = 2;
	var block_size = total_num_dm_trials/total_num_blocks; // number of trials we want to have in each session


	// set glabal variables for all of our dimensions
	var aperture_x_coords ;
    var aperture_y_coords ;
    var aperture_diam; // diameter of the rdk apertures
    var dot_size;


    // add properties we want to know to the data
    jsPsych.data.addProperties({porder_schedule: random_porder_index});

    ////////////////////////////////////////////////////////
    // Begin compiling experiment
    ////////////////////////////////////////////////////////


    /* CREATE TIMELINE */
	var timeline = [];


	// node to enter fullscreen
	var enter_fullscreen = {
	    type: "fullscreen",
	    fullscreen_mode: true,
	    on_finish: function(){
	    	///////////////////////////////////
	    	// now that we are in fullscreen we want to set all of the dimensions we will be using in the experiment
	    	aperture_x_coords =  [(window.innerWidth/2-window.innerWidth/10), //the cordinates of each of the 4 aperturesopleft
	    						   (window.innerWidth/2-window.innerWidth/10),
	                        	   (window.innerWidth/2+window.innerWidth/10), //topright
	                        	   (window.innerWidth/2+window.innerWidth/10)];
	    	aperture_y_coords =  [(window.innerHeight/2-window.innerHeight/8),
	                        	  (window.innerHeight/2+window.innerHeight/8),
	                        	  (window.innerHeight/2-window.innerHeight/8),
	                        	  (window.innerHeight/2+window.innerHeight/8)];
	        // add all of th eother dimensions to be updated here
	        aperture_diam = window.innerHeight/5;
	        dot_size = window.innerHeight/500;
	        dec_arw_display.arrowhead_length= window.innerHeight/20 ;
			dec_arw_display.arrow_body_thickness= aperture_diam/20;
      		dec_arw_display.arrow_head_thickness= dec_arw_display.arrow_body_thickness/2,
			dec_arw_display.arrow_head_angle= 30;

			fb_box_display.fb_line_thick= 3;
			fb_box_display.fb__box_wdt= aperture_diam*1.3;
      		fb_box_display.fb__box_ht= aperture_diam*2.5;

      		
          
    	}
   	}

  	timeline.push(enter_fullscreen)

  	// first set of instructions
  	var instructions_1 = {
		type: 'instructions',
		pages: function() {return [
		 '<h1>Welcome to the group competition game!</h1>'+
         '<div style="text-align: left; font-size:22px"> '+
		 '<p><br><br><br><li> Thank you for participating.</p>'+

		'<br><p><li>The game will take about 30 minutes and has two parts:</p>'+
        '<ul><ul><ul>'+
		 '<p> 1) Individual performance assessment (~5 min) </br> 2) The group competition task (~25 min)<p>'+
	    '</ul></ul></ul>' +
		 //'<br><p><li>Press the arrow as button to proceed to the next screen.</p>'+
		 '<br>'+
         '</div>'
		]},
		show_clickable_nav: true,
		button_label_previous: '',
		button_label_next: ''
  	}

    timeline.push(instructions_1)



	//----------------------------------------------------------------------
	// next three blocks all used to get initials and check they are correct
	//initials block 1
	var get_initials = {
		type: "survey-text",
		questions: [ {prompt: 'Please enter your initials (e.g. MK):', required: true}],
		on_finish: function(data) {
		    initials = data.response.Q0.toUpperCase();
			data.player = initials;
		    
		}
	}

	// intials block 2
	var confirm_initials = {
		type: "survey-multi-choice",
		questions: [{
			prompt: function() {
			var playerid   = initials; //jsPsych.data.get().select('player').values[0];
			return 'Please confirm your initials are: ' +playerid+ '';
			},
		  name: 'confirmInitials',
		  options: ['Confirm', 'Re-enter initals'],
		  required: true
		}],
	};


	var shorten_initials = {
		type: "survey-text",
		questions: [ {prompt: 'Please make sure your initials have 3 letters or less. Enter your initials in the box below:', required: true}],
		on_finish: function(data) {
		    initials = data.response.Q0.toUpperCase();
		}
	}

	var if_too_long = {
	    timeline: [shorten_initials],
	    loop_function: function(){
	        var playerid   = initials;

	        if(playerid.length >3){
	            return true;
	        } else {
	            return false;
	        }
	    }
	}

	var check_if_too_long = {
	    timeline: [if_too_long],
	    conditional_function: function(){
	        var playerid   = initials;

	        if(playerid.length >3){
	            return true;
	        } else {
	            return false;
	        }
	    }
	}

	// //initials block 3
	// var Get_ID_loop = {
	//     timeline: [get_initials,check_if_too_long,confirm_initials],
	//     loop_function: function(){
	//         var data = jsPsych.data.get().last(1).values()[0];
	//         if(jsPsych.pluginAPI.compareKeys(data.response.confirmInitials, 'Confirm')){
	//             data.player = initials;
	//             return false;
	//         } else {
	//             return true;
	//         }
	//     }
	// }

		//initials block 3
		var Get_ID_loop = {
	    timeline: [get_initials],
	    // loop_function: function(){
	    //     var data = jsPsych.data.get().last(1).values()[0];
	    //     if(jsPsych.pluginAPI.compareKeys(data.response.confirmInitials, 'Confirm')){
	    //         data.player = initials;
	    //         return false;
	    //     } else {
	    //         return true;
	    //     }
	    // }
	}


	timeline.push(Get_ID_loop);
	// finished with initials
	//------------------------------------------------------------------



	//-------------------------------------------------------------------
	//----------------Show instructions for RDM---------------------
	var rdm_instructions_1 = {
		// get the subjects initials
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;
			// add the initials to the logfile
			jsPsych.data.addProperties({initals: p1});
			return ;
			},
		type:"RDM-instruction",
		instr_num: -1, //
		screen_num: 0, //number of sscreens that participant has to flicjk through
		trial_duration: Main_decision_duration,
		response_ends_trial: true,
		choices: ["arrowright"],
		number_of_apertures: Aperturenum,
		player_colours: player_cols,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: false,
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};

	//timeline.push(rdm_instructions_1): move this screen below related to how two teams will be diplay

	var rdm_instructions_2 = {
		type: 'instructions',
		pages: function() {return [

			'<h1>1)  Individual performance assessment</h1>'+
             //'<h2<u> Tag </h2>>'+
			'<br><div style="text-align: left; font-size:18px">'+
			'<p><li>We ask you to perform a “random dot motion” task, in which you will see dot motion clouds moving to the left or to the right. <p>'+

			'<br><p><li>Please press the “left” or “right” arrow button on your keyboard to indicate the correct direction.<p>'+
			'<ul><ul><ul>'+
			'<p>&#8594   Correct performance will be displayed as:  <img src="images/fb_correct.png" width="30px" class="center">;<p>'+
			'<p>&#8594   Incorrect performance will be displayed as: <span style="color: red; font-weight:bold; font-size:35px";>× </span>;<p>'+ //<img src="images/fb_wrong.png" width="50px" class="center">
			'<p>&#8594   No response in time will be displayed as <u><strong>"Missed"</u></strong>, and will be counted as incorrect;'+
			'</ul></ul></ul>'+ 
			'<br><p><li>Try to pay your full attention and be as quick and accurate as possible.<p>'+

			'<br><p><li>Press the right arrow key to start when you are ready.</p></li>'+
			'<br>'+
            '</div>'

		]},
		show_clickable_nav: true,
		button_label_previous: '',
		button_label_next: ''
	}

 	timeline.push(rdm_instructions_2)

	//----------------end of instructions for RDM------------------------
	//-------------------------------------------------------------------


	//-------------------------------------------------------------------
	//----------------Begin RDM training---------------------------------

	// this node  shows 4 circular apertures with player ids and is used in training and actual rdm experiment
	var RDM_pretrial = {
		// get the subjects initials
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;
			return ;
		},
		type:"RDM-pretrial",
		player_colours: player_cols,
		trial_duration: RDM_pretrial_duration,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: borders,
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		}
	};


	// // this node is the training rdk trial its different from main only in the sequence it uses
	// var RDM_training_trial = {
	// 	type:"RDM-trial",
	// 	trial_duration: RDM_trial_duration,
	// 	coherent_direction: function(){
	// 		chosenValue = Math.random() < 0.5 ? 0 : 180;
	// 		return chosenValue;
	// 	},
	// 	correct_choice: function(){
	// 		if (chosenValue == 0) {
	// 			return correct_ans_right
	// 		}else if (chosenValue == 180) {
	// 			return correct_ans_left
	// 		}
	// 	},
	// 	coherence: jsPsych.timelineVariable('coh'),
	// 	training_trial: true, // using this because training and main rdm trial reliy on same plugin and i cant deliniate responses for later calculatinos without
	// 	RDK_type: RDktype, //Applied to all apertures if only one value
	// 	aperture_type: Aperturetype, // circle
	// 	player_position: positions,
	// 	border: borders,
	// 	player_colours: player_cols,
	// 	number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
	// 	initials_font: display_initials,
	// 	aperture_center_x: function(){
	// 		return aperture_x_coords
	// 	},
	// 	aperture_center_y: function(){
	// 		return aperture_y_coords
	// 	},
	// 	aperture_width: function(){
	// 		return aperture_diam
	// 	},
	// 	dot_radius: function(){
	// 		return dot_size
	// 	}
	// };


	// this node presents feedback on rdm choices in the training phase
	var RDM_training_fb = {
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;
		},
		type:"RDM-training-fb",
		number_of_apertures: Aperturenum, //This needs to be set if more than one aperture
		trial_duration: RDM_training_fb_duration,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		player_colours: player_cols,
		aperture_type: Aperturetype, // circle
		border: borders,
		feedback: function(){
			var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
			var last_response      = jsPsych.data.get().last(1).values()[0].response;
			if (last_response == -1){
				return 2;
			};
			if(last_trial_correct){
				return 1;
			} else {
				return 0;
			}
		},
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};


	//-------------------------------------------------------------------------
	//----------Actual RDM nodes ----------------------------------------------
	// this node is the main rdk trial which displays the moving dots
	
	var RDM_trial = {
	    type:"RDM-trial",
	    trial_duration: RDM_trial_duration,
	    coherent_direction: function(){
			chosenValue = Math.random() < 0.5 ? 0 : 180;
			return chosenValue;
	    },
	    coherence: function(){
			cohValue = Math.random() < 0.8 ? 0.032 : 0.512;
			return cohValue;
	    },
	    correct_choice: function(){
			if (chosenValue == 0) {
				return correct_ans_right
			}else if (chosenValue == 180) {
				return correct_ans_left
			}
		},
		training_trial: false,
	    RDK_type: RDktype, //Applied to all apertures if only one value
	    aperture_type: Aperturetype, // circle
	    player_on:0, // index of the player to show rdk for [self,partner,op1,op2]
	    player_position: positions,
	    border: false,
	    player_colours: player_cols,
	    number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
	    initials_font: display_initials,
	    aperture_center_x: function(){
	    	return aperture_x_coords
	    },
	    aperture_center_y: function(){
	    	return aperture_y_coords
	    },
	    aperture_width: function(){
	    	return aperture_diam
	    },
	    dot_radius: function(){
	    	return dot_size
	    },
	    on_finish: function(data){
	      saveData('outfile', jsPsych.data.get().csv());
	      var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});

	    }
	};


    

	// this node gives feedbback on rdk choice only if no answer was given
	var RDM_fb = {
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;
		},
		type:"RDM-fb",
		number_of_apertures: Aperturenum, //This needs to be set if more than one aperture
		trial_duration: RDM_training_fb_duration,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		player_colours: player_cols,
		aperture_type: Aperturetype, // circle
		border: borders,
		feedback: function(){
			var last_response = jsPsych.data.get().last(1).values()[0].response;
			if(last_response == -1){
				return 2;
			} else {
				return 0;
			}
		},
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};



	//------------------------------------------------------------------------------------------
	//-----------these next blocks are conditional blocks if certain performance criteria are met

	// // additional trial if none of the previous responses were corect. it gets fed into the node
	// var RDM_training_ifnoneright_trial = {
	//     type:"RDM-trial",
	//     trial_duration: RDM_trial_duration,
	//     coherent_direction: function(){
	//     	chosenValue = Math.random() < 0.5 ? 0 : 180;
	//     	return chosenValue;
	//     },
	//     correct_choice: function(){
	//     	if (chosenValue == 0) {
	//     		return correct_ans_right
	//     	}else if (chosenValue == 180) {
	//     		return correct_ans_left
	//     		}
	//     },
	//     coherence: 	    0.512,
	//     RDK_type: 	    RDktype, //Applied to all apertures if only one value
	//     aperture_type:  Aperturetype, // circle
	//     player_position:positions,
	//     border:         borders,
	//     player_colours: player_cols,
	//     number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
	//     initials_font: display_initials,
	//     aperture_center_x: function(){
	//     	return aperture_x_coords
	//     },
	//     aperture_center_y: function(){
	//     	return aperture_y_coords
	//     },
	//     aperture_width: function(){
	//     	return aperture_diam
	//     },
	//     dot_radius: function(){
	//     	return dot_size
	//     }
	// };

	// // additional trial if none of the previous responses were corect. it gets fed into the node
	// var RDM_training_ifnonewrong_trial = {
	//     type:"RDM-trial",
	//     trial_duration: RDM_trial_duration,
	//     coherent_direction: function(){
	//     	chosenValue = Math.random() < 0.5 ? 0 : 180;
	//     	return chosenValue;
	//     },
	//     correct_choice: function(){
	//     	if (chosenValue == 0) {
	//     		return correct_ans_right
	//     	}else if (chosenValue == 180) {
	//     		return correct_ans_left
	//     		}
	//     },
	//     coherence: 0.032,
	//     RDK_type: RDktype, //Applied to all apertures if only one value
	//     aperture_type: Aperturetype, // circle
	//     player_on:0, // index of the player to show rdk for [self,partner,op1,op2]
	//     player_position: positions,
	//     border: borders,
	//     player_colours: player_cols,
	//     number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
	//     initials_font: display_initials,
	//     aperture_center_x: function(){
	//     	return aperture_x_coords
	//     },
	//     aperture_center_y: function(){
	//     	return aperture_y_coords
	//     },
	//     aperture_width: function(){
	//     	return aperture_diam
	//     },
	//     dot_radius: function(){
	//     	return dot_size
	//     }
	// };

	// // if none right we want to show two of additional trial sequences
	// var if_no_Right_node = {
	// 	repetitions: 1,
	//     timeline: [ RDM_training_ifnoneright_trial,  RDM_training_fb,  RDM_training_ifnoneright_trial,  RDM_training_fb],
	//     conditional_function: function(){
	//         // get the data from the previous trial,
	//         // and check which key was pressed
	//         var sum_correct = jsPsych.data.get().select('correct').sum();
	//         if(sum_correct == 0){
	//             return true;
	//         } else {
	//             return false;
	//         }
	//     }
	// }

	// // if none wrong we want to show two of additional trial sequences
	// var if_no_Wrong_node = {
	// 	repetitions:1,
	//     timeline: [ RDM_training_ifnonewrong_trial,  RDM_training_fb,  RDM_training_ifnonewrong_trial,  RDM_training_fb],
	//     conditional_function: function(){
	//         // get the data from the previous trial,
	//         // and check which key was pressed
	//         //var sum_incorrect = jsPsych.data.get().select({correct: false}).sum();
	//         var sum_correct 	= jsPsych.data.get().select('correct').sum();
	//         var sum_no_response = jsPsych.data.getLastTimelineData().select('no_response').sum();
	//         if(sum_correct+sum_no_response == 8 || sum_no_response == 8){
	//             return true;
	//         } else {
	//             return false;
	//         }
	//     }
	// }


	///////////////////////////////////////////////
	// this is the rdm training block of 8 trials
	//---------------------------------------------
	// var RDM_training_block = {
	// 	timeline: [RDM_training_trial,RDM_training_fb],
	// 	timeline_variables: RDM_training_schedule,
	// 	randomize_order:false
	// }
	
	//timeline.push(RDM_pretrial)
	//timeline.push(RDM_training_block)


    // this is the main block which shows the rdm trials with feedback
		var RDM_training_block = {
		timeline: [RDM_trial,RDM_training_fb],
		repetitions: num_RDM_training_trials,
		on_timeline_start: function(){
		},
		on_timeline_finish: function(){
		}
	}
	
	timeline.push(RDM_pretrial)
	timeline.push(RDM_training_block)

	///////////////////////////////////
	// this is a conditional block if any of the criteria are met ( none, right none wrong)
	// var RDM_training_if_block = {
	// 	timeline: [if_no_Right_node,if_no_Wrong_node],
	// 	//timeline_variables: RDM_training_schedule,
	// 	randomize_order:false,
	// 	repetitions:1
	// }
	
	
	//timeline.push(RDM_training_if_block)

//---------------------------------------------
///------------ Training Ends ------------///
//----------------------------------------------



//---------------------------------------------
///------------ RDM task begins ------------///
//----------------------------------------------
	var instructions_3 = {
		type: 'instructions',
		pages: function() {return [
			'<h1> 1) Individual performance assessment</h1>'+
			'<br><br><div style="text-align: left; font-size:18px">'+
			'<p><li>Well done! Now we ask you to continue the same task again, but you <u><strong>will not</strong></u> see performance feedback anymore.</p>'+
			'<br><p><li> Try to pay your full attention and be as quick and accurate as possible. <p>'+
			'<br><p><li> Press right arrow key to start when you are ready.<p>' +
             '<br>'+
			 '</div>'
		]},
		show_clickable_nav: true,
		button_label_previous: '',
		button_label_next: '',
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	}

	timeline.push(instructions_3)


	// useful node to insert if you want to check the data output from a given triafl
	var show_data = {
		 type: "html-button-response",
		 stimulus: function() {
			var trial_data = jsPsych.data.getLastTrialData().values();
			var trial_json = JSON.stringify(trial_data, null, 2);
			return `<p style="margin-bottom:0px;"><strong>Trial data:</strong></p>
			 <pre style="margin-top:0px;text-align:left;">${trial_json}</pre>`;
		 },
		 choices: ['Repeat demo']
	};



	// this is the main block which shows the rdm trials
	var RDM_block = {
		timeline: [RDM_trial,RDM_fb],
		repetitions: num_RDM_trials,
		on_timeline_start: function(){
		},
		on_timeline_finish: function(){
		}
	}
	
	timeline.push(RDM_pretrial)
	timeline.push(RDM_block)



	//  if they didnt respond to a lot of trials then we want to add more
	var if_missed_lots = {
		repetitions: num_RDM_repeat_trials,
	    timeline: [RDM_trial,RDM_fb],
	    //timeline_variables: RDM_schedule,
	    conditional_function: function(){
	        // get the data from the previous trial,
	        // and check which key was pressed
	        var sum_no_response = jsPsych.data.get().filter({no_response:true}).count();
	        var total_trial_num = jsPsych.data.get().filter({rdm_trial_count:true}).count();
	        //var percent_no_resp = sum_no_response/total_trial_num;
			var percent_no_resp = sum_no_response/(total_trial_num)
	        if(percent_no_resp > .2 & ((total_trial_num-sum_no_response)<enough_rdm_trials)){
	            return true;
	        } else {
	            return false;
	        }
	    },
	    loop_function: function(){
	        // get the data from the previous trial,
	        // and check which key was pressed
	        var sum_no_response = jsPsych.data.get().filter({no_response:true}).count();
	        var total_trial_num = jsPsych.data.get().filter({rdm_trial_count:true}).count();
	        //var percent_no_resp = sum_no_response/total_trial_num;
			var percent_no_resp = sum_no_response/(total_trial_num)
	        if(percent_no_resp > .2 & ((total_trial_num-sum_no_response)<enough_rdm_trials)){
	            return true;
	        } else {
	            return false;
	        }
	    }
	}


	var RDM_instructions_4 = {
		type: 'instructions',
		pages: function() {return [
			'<br><br><div style="text-align: centre; font-size:40px">'+
			'<p> <strong>Well done for completing Part 1! </strong> </p>'+
			
			'<br><br><div style="text-align: centre; font-size:25px">'+
			'<p> Please press right arrow key to start Part 2 - the group competition task. <p>'+
            '<br>'+
			'</div>'
		]},
		show_clickable_nav: true,
		button_label_previous: '',
		button_label_next: '',
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	}
	
	
	timeline.push(if_missed_lots)
	timeline.push(RDM_instructions_4)



//---------------------------------------------
///------------ RDM task ends ------------///
//----------------------------------------------


//---------------------------------------------
///------------ interlude: pairing schedules ------------///
//----------------------------------------------

	// tell participants we are pairing schedules
	var pair_schedules = {
		type: 'preparing-schedules',
		response_ends_trial: true,
		background_color:bcgnd_color,
		on_finish: function(){
			RDM_performance = jsPsych.data.get().filter({trial_type:"RDM-trial", correct:true}).count();
			var all_trials  = jsPsych.data.get().select('rdm_trial_count').sum();  // this includes the practice trials (these can be excluded with more effort...lol)
			RDM_performance = RDM_performance/all_trials;
			// pair schedules
			closest_sch_value = rdmperf.reduce((a, b) => {
				return Math.abs(b - RDM_performance) < Math.abs(a - RDM_performance) ? b : a;
			});
			// now get the index of this schedule
			closest_sch_index = rdmperf.indexOf(closest_sch_value);
			//var schedule_id   = "main_sch_" + closest_sch_index;
			
			var schedule_id   = "DUMMY_main_sch_" + closest_sch_index;
			this_subs_schedule = eval(schedule_id); // to replace line 53 oncethe schedues are completed
    		jsPsych.data.addProperties({main_schedule: closest_sch_index});

			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	}

	//timeline.push(pair_schedules)
//--------------------------------------------------------------------


//---------------------------------------------
///------------ Main trainin gbegins ------------///
//----------------------------------------------
	var instructions_4 = {
       type: 'instructions',
       pages: function() {return [

          '<h1>2) Group competition task </h1>'+

		  '<br><div style="text-align: left; font-size:18px">'+
          '<br><p><li>In this part, we will show you the performance we recorded for you and the other three players during the performance assessment. <p>'+
           
          '<p><br><li>Performance will be displayed as: <img src="images/fb_correct.png" width="30px" class="center"> ; Incorrect performance will be displayed as:<span style="color:red; font-weight:bold;font-size:35px";> x </span>.<p>'+
           
		  '<p><br><li>Keep track of the number of correct performances and make decisions about them! </p>'+
		  '<p><br><li>Press right arrow key to see an example.<p>'+
           '<br>'+
		   '</div>'
       ]},
       show_clickable_nav: true,
       button_label_previous: '',
       button_label_next: '',
       on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
    }

	timeline.push(rdm_instructions_1)
	timeline.push(instructions_4)



	/// this node presents the feebcak for each particiapant in order using the set practicce sequence
	var main_practice_sequence = {
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;
			return ;
		},
		type:"main-fb-sequence",
		trial_duration: Main_fb_sequence_dur,
		coherent_direction: function(){
			chosenValue = Math.random() < 0.5 ? 0 : 180;
			return chosenValue;
	    },
		S_perf : [1,1,0,1,0,1], //This is the sequence we need
		P_perf : [1,0,1,1,1,0],
		O1_perf : [1,1,1,1,0,1],
		O2_perf : [1,0,0,1,0,0],
		RDK_type: RDktype, //Applied to all apertures if only one value
		coherence: 0.75,
		player_position: positions,
		p_order: [1,0,2,3], 
		border: false,
		player_colours: player_cols,
		number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
		initials_font: display_initials,
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};

	timeline.push(main_practice_sequence)



	// This is the first main decision ( note it needs to be seperate because it relies on dec_num to select the create decision from schedule)
	var main_instructions_1 = {
		// get the subjects initials
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;
			var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
			trial.previous_dot_positions = dotArray3d;
			return ;
		},
		type:"main-instruction",
		instr_num: 3, // first or second decison
		screen_num: 2,//1, //number of sscreens that participant has to flicjk through
		dectype: 2,
		initials_font: display_initials,
		outcomeEngage: 0,
		trial_duration: Main_decision_duration,
		response_ends_trial: true,
		choices: Main_decision_choices,
		player_colours: player_cols,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: false,
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		fb_box: fb_box_display,
		dec_arrow: dec_arw_display,
		arrow_apppearance: function(){
			return decision_arrow
		},
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};

	//Adding the practice sequence

var main_instructions_2 = {
		// get the subjects initials
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;
			var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
			trial.previous_dot_positions = dotArray3d;
			return ;
		},
		type:"main-instruction",
		instr_num: 0, 
		screen_num: 0,//1, //number of sscreens that participant has to flicjk through
		dectype: 2,
		initials_font: display_initials,
		outcomeEngage: 0,
		trial_duration: Main_decision_duration,
		response_ends_trial: true,
		choices: ["arrowright"],
		player_colours: player_cols,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: false,
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		fb_box: fb_box_display,
		dec_arrow: dec_arw_display,
		arrow_apppearance: function(){
			return decision_arrow
		},
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};



	var main_instructions_3 = {
		// get the subjects initials
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;

			var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
			trial.previous_dot_positions = dotArray3d;
			//var test = jsPsych.data.getLastTrialData().select('aperture_center_x').values[1];
			return ;
		},
		type:"main-instruction",
		instr_num: 1, // first or second decison
		screen_num: 0, //number of sscreens that participant has to flicjk through
		dectype: 2,
		outcomeEngage: 0,
		trial_duration: Main_decision_duration,
		response_ends_trial: true,
		choices: ["arrowright"],
		player_colours: player_cols,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: false,
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		fb_box: fb_box_display,
		dec_arrow: dec_arw_display,
		arrow_apppearance: function(){
			return decision_arrow
		},
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};

	var main_instructions_4 = {
		// get the subjects initials
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;

			var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
			trial.previous_dot_positions = dotArray3d;
			//var test = jsPsych.data.getLastTrialData().select('aperture_center_x').values[1];
			return ;
		},
		type:"main-instruction",
		instr_num: 4, // first or second decison
		screen_num: 1, //0, //number of sscreens that participant has to flicjk through
		dectype: 3,
		outcomeEngage: 0,
		trial_duration: Main_decision_duration,
		response_ends_trial: true,
		choices: Main_decision_choices,
		player_colours: player_cols,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: false,
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		fb_box: fb_box_display,
		dec_arrow: dec_arw_display,
		arrow_apppearance: function(){
			return decision_arrow
		},
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};

	var main_instructions_5 = {
		// get the subjects initials
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;

			var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
			trial.previous_dot_positions = dotArray3d;
			//var test = jsPsych.data.getLastTrialData().select('aperture_center_x').values[1];
			return ;
		},
		type:"main-instruction",
		instr_num: 2, // first or second decison
		screen_num: 0, //0, //number of sscreens that participant has to flicjk through
		dectype: 3,
		outcomeEngage: 0,
		trial_duration: Main_decision_duration,
		response_ends_trial: true,
		choices: ["arrowright"],
		player_colours: player_cols,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: false,
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		fb_box: fb_box_display,
		dec_arrow: dec_arw_display,
		arrow_apppearance: function(){
			return decision_arrow
		},
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};

	timeline.push(main_instructions_1)
	timeline.push(main_instructions_2)
	timeline.push(main_practice_sequence)
	timeline.push(main_instructions_3)
	timeline.push(main_instructions_4)
	timeline.push(main_instructions_5)

	var main_instructions_6 = {
		type: 'instructions',
		pages: function() {return [
		 '<h1> 2) Group competition task </h1>'+
		 //'<br><p><div style="text-align:left; font-weight:bold; font-size:30px"> Notes:</div></p>'+
		 '<br><div style="text-align: left; font-size:20px">'+
		 '<p><li> For each round, you will make two decisions about the performances.</p>'+
		 '<br><p><li>Now we can start. Remember: </p>' +
	     '<ul><ul>'+
		 '<br>&#8594 Track the performances for everyone.'+
		 '<br>&#8594 Make correct decisions by picking the better performer.'+
		 '<br>&#8594 Getting decisions about your partner right is just as important as getting decisions about yourself right.'+
		 '</ul></ul>'+
		 '<br><p><li> Press below right arrow key to proceed to next screen: you will be paired with three other players and start the task.</p>' + //<br> - Let’s do a practice round, in which we will show whether your decision is correct or not <strong>(?)</strong>. 
		'<br>'+
		'</div>'
		]},
		show_clickable_nav: true,
		button_label_previous: '',
		button_label_next: '',
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	}

	timeline.push(main_instructions_6)
    timeline.push(pair_schedules)


	// // draw feedback boxes with text feedback overlayed
	// var main_training_fb = {
	// 	on_start: function(trial){
	// 		var p1   = jsPsych.data.get().select('player').values[0];
	// 		trial.player1 = p1;

	// 		var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
	// 		trial.previous_dot_positions = dotArray3d;
	// 	},
	// 	dec_num: 1, // first or second decison
	// 	dectype: jsPsych.timelineVariable('dectype'),
	// 	type:"main-training-fb",
	// 	number_of_apertures: Aperturenum, //This needs to be set if more than one aperture
	// 	trial_duration: Main_training_decision_fb_dur,
	// 	RDK_type: RDktype, //Applied to all apertures if only one value
	// 	player_position: positions,
	// 	player_colours: player_cols,
	// 	aperture_type: Aperturetype, // circle
	// 	border: false,
	// 	outcomeEngage: jsPsych.timelineVariable('outcomeEngage'),
	// 	engaged: function(){
	// 		var last_resp = jsPsych.data.get().last(1).values()[0].response;
	// 		if(jsPsych.pluginAPI.compareKeys(last_resp, 'arrowleft')){
	// 			return 0;
	// 		} else if (jsPsych.pluginAPI.compareKeys(last_resp, 'arrowright')) {
	// 			return 1
	// 		}
	// 	},
	// 	background_color: bcgnd_color,
	// 	border_color: player_cols,
	// 	initials_font: display_initials,
	// 	fb_box: fb_box_display,
	// 	aperture_center_x: function(){
	// 		return aperture_x_coords
	// 	},
	// 	aperture_center_y: function(){
	// 		return aperture_y_coords
	// 	},
	// 	aperture_width: function(){
	// 		return aperture_diam
	// 	},
	// 	dot_radius: function(){
	// 		return dot_size
	// 	}
	// };






	/// this node presents the performance feebcak from the rdm task for each particiapant in order using the schedules
	var main_fb_sequence = {
		on_start: function(trial){
			// get the players name
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;

			// get the values from the schedule assigned to this player
			trial.p_order = Object.values(porder_sch[main_trial_count]); // access the actual values
			trial.S_perf = Object.values(this_subs_schedule[main_trial_count].S_perf);
			trial.P_perf = Object.values(this_subs_schedule[main_trial_count].P_perf);
			trial.O1_perf = Object.values(this_subs_schedule[main_trial_count].O1_perf);
			trial.O2_perf = Object.values(this_subs_schedule[main_trial_count].O2_perf);
			trial.outcomeEngage = Object.values(this_subs_schedule[main_trial_count].outcomeEngage);
			return ;
		},
		type:"main-fb-sequence",
		trial_duration: Main_fb_sequence_dur,
		coherent_direction: function(){
			chosenValue = Math.random() < 0.5 ? 0 : 180;
			return chosenValue;
	    },
		coherence: 0.75,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: false,
		player_colours: player_cols,
		number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
		initials_font: display_initials,
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};


	// This is the first main decision ( note it needs to be seperate because it relies on dec_num to select the create decision from schedule)
	var main_decision_practice = {
		// get the subjects initials
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;

			var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
			trial.previous_dot_positions = dotArray3d;
			return ;
		},
		type:"main-decision-training",
		dectype: jsPsych.timelineVariable('dectype'),
		outcomeEngage: jsPsych.timelineVariable('outcomeEngage'),
		response_ends_trial: true,
		choices: Main_decision_choices,
		player_colours: player_cols,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: false,
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		dec_arrow: dec_arw_display,
		arrow_apppearance: function(){
			return decision_arrow
		},
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};

	// This is the first main decision ( note it needs to be seperate in the main task because we relies on dec_num to select the create decision from schedule - (this is not the case in main training)
	var main_decision_1 = {
		// get the subjects initials
		on_start: function(trial){
			// get the players name
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;

			// get the values from the schedule assigned to this player
			trial.dectype = Object.values(this_subs_schedule[main_trial_count].dectype);
			trial.outcomeEngage = Object.values(this_subs_schedule[main_trial_count].outcomeEngage);

			  // take the array of dots from the last screen to keep display consistant
			var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
			trial.previous_dot_positions = dotArray3d;
			//var test = jsPsych.data.getLastTrialData().select('aperture_center_x').values[1];
			return ;
		},
		type:"main-decision",
		dec_num: 0, // first or second decison
		response_ends_trial: true,
		choices: Main_decision_choices,
		player_colours: player_cols,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: false,
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		dec_arrow: dec_arw_display,
		arrow_apppearance: function(){
			return decision_arrow
		},
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){

			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		
			var engaged   = jsPsych.data.getLastTrialData().select('response').values[0];
			var engagepoints = jsPsych.data.getLastTrialData().select('outcome_engage').values[0];
			if (engaged == 'arrowleft'){  // replaced by 'arrowleft'?
				data.points = engagepoints;
			}
		}
	};



	var main_decision_2 = {
		// get the subjects initials
		on_start: function(trial){
			// get the players name
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;

			// get the values from the schedule assigned to this player
			trial.dectype = Object.values(this_subs_schedule[main_trial_count].dectype);
			trial.outcomeEngage = Object.values(this_subs_schedule[main_trial_count].outcomeEngage);

			// increment the trial counter ( this only happens in this trial node but applies to all nodes in this timeline)
			main_trial_count++; // increment trial counter

			// take the array of dots from the last screen to keep display consistant
			var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
			trial.previous_dot_positions = dotArray3d;
			return ;
		},
		type:"main-decision",
		dec_num: 1, // first or second decison
		response_ends_trial: true,
		choices: Main_decision_choices,
		player_colours: player_cols,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		border: false,
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		dec_arrow: dec_arw_display,
		arrow_apppearance: function(){
			return decision_arrow
		},
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		
			var engaged   = jsPsych.data.getLastTrialData().select('response').values[0];
			var engagepoints = jsPsych.data.getLastTrialData().select('outcome_engage').values[0];
			if (engaged == 'arrowleft'){  //replace by 'arrowleft'?
				data.points = engagepoints;
			}
		}
	};


	// draw feedback boxes
	var main_fb = {
		on_start: function(trial){
			var p1   = jsPsych.data.get().select('player').values[0];
			trial.player1 = p1;
			var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
			trial.previous_dot_positions = dotArray3d;
		    //trial.outcomeEngage = Object.values (this_subs_schedule[main_trial_count].outcomeEngage) -adding this command will interrupt data saving, but I don't know why -YL;
		},
		type:"main-fb",
		number_of_apertures: Aperturenum, //This needs to be set if more than one aperture
		trial_duration: Main_decision_fb_dur,
		RDK_type: RDktype, //Applied to all apertures if only one value
		player_position: positions,
		player_colours: player_cols,
		aperture_type: Aperturetype, // circle
		border: false,
		feedback: function(){
			var last_resp = jsPsych.data.get().last(1).values()[0].response;
			if(jsPsych.pluginAPI.compareKeys(last_resp, 'arrowleft')){
				return 0;
			} else if (jsPsych.pluginAPI.compareKeys(last_resp, 'arrowright')) {
				return 1
			}
		},
		background_color: bcgnd_color,
		border_color: player_cols,
		initials_font: display_initials,
		fb_box: fb_box_display,
		aperture_center_x: function(){
			return aperture_x_coords
		},
		aperture_center_y: function(){
			return aperture_y_coords
		},
		aperture_width: function(){
			return aperture_diam
		},
		dot_radius: function(){
			return dot_size
		},
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};

	// node added to the end of our 'trial' timelines to create an intertrial interval
	var ITI = {
		type: 'html-keyboard-response',
		stimulus: '',
		trial_duration:500,
		response_ends_trial: false,
		on_finish: function(data){
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};



	// // create timeline for the main block
	// var main_training_block = {
	// 	timeline: [ main_decision_practice, main_training_fb,ITI],
	// 	timeline_variables: main_trial_training_schedule,
	// 	randomize_order:false,
	// 	on_timeline_start: function(){
	//   }
	// }

	//timeline.push(main_practice_sequence) // only show the sequence once
	//timeline.push(main_training_block)    // then ask 4 questions


	// var main_instructions_5 = {
	// 	type: 'instructions',
	// 	pages: function() {return [
	// 		'<h1>Part 2 –The group competition task </h1>'+
	// 		'<br><div style="text-align:left;font-size:22px">'+
	// 		'<br><p><li>We now ask you to do this task for approximately 25 minutes. </p>'+ //Well done! 
	// 		'<br><p><li>Try to keep track of everyone’s performance as well as you can and make accurate decisions.</p>'+
	// 		'<br><p><li>After every performance phase, you only need to do <u>two</u> decisions (one after the other).</p>' +
	// 		'<br><p><li>The decisions always refer to the performances you have seen just before. These performances will be <strong> NEW </strong> every time you see them. </p>'+
	// 		'<p>This will be different to the practical round just now and it will be a real challenge to keep track of the information! </p>'+
	// 		//'<br><p><li>You will know your cumulative points when you finish one session. </p>'+ //Your decision outcome will not be shown on every round, but 
	// 		'<br><p><li>If you are ready, press the right arrow as button to start.</p>' +
	// 		'<br>'+
	// 		'</div>'
	// 	]},
	// 	show_clickable_nav: true,
	// 	button_label_previous: '',
	// 	button_label_next: ''
	// }

	//timeline.push(main_instructions_5)


	var break_trial = {
		type: 'html-keyboard-response',
		stimulus: function (){
			var sum_points = jsPsych.data.get().select('points').sum();
			var numbreaks  = 1+ jsPsych.data.get().select('break').sum();
			return [ 	//"<p style='font-size: 25px'>Time to take a break!</p>" +
		           		"<p style = 'font-size: 25px'> " + numbreaks + " sessions of " + total_num_blocks + " finished, you made " + sum_points + " points so far in the task </p>" +
				   		"<p style = 'font-size: 25px'> Take a rest for about a minute. Then, Continue by pressing right arrow key </p>"
		 				
				   ]
		},
		choices: ["arrowright"],
		on_finish: function(data){
			data.break = 1;
			var interactions = jsPsych.data.getInteractionData().last(1);
			jsPsych.data.addDataToLastTrial({interaction_data: interactions.json()});
		}
	};

	var break_conditional = {
		timeline: [break_trial],
		conditional_function: function() {
			// increment trial count - in first run through the timeline variables procedure, trial_count will be equal to 1
			
			if (trial_count>0 & trial_count % block_size == 0) {
				// if the trial count is divisible by blocksize, then run the break trial
				trial_count++;
				return true;
			} else {
				// otherwise skip the break trial
				trial_count++;
				return false;
			}
		}
	};


   

	// create timeline for the main block
	var main_block = {
		timeline: [break_conditional,main_fb_sequence,main_decision_1, main_fb, main_decision_2, main_fb,ITI],
		timeline_variables : DUMMY_main_sch, //this_subs_schedule,//// Now give the block an empty set of arrays of length = number of trials we warrant
		// the paramaters we want are assigned dynamically in the
		on_timeline_start: function(){
			main_trial_count = 0;
		},
		on_timeline_finish: function(){
			//////////////////////////
			// save data from here////
			//////////////////////////
		}

	}

	timeline.push(main_block)

	

	// this node is shown so that we can make sure we have enoguht time to save all of the participants data
	var saving_data = {
    type: 'call-function',
    async: true,
		func: function(){
            // following code copies savedata function but  runs async so we know data is saved before exp ends
            var xhr = new XMLHttpRequest();
        		xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
        		xhr.setRequestHeader('Content-Type', 'application/json');
        		xhr.send(JSON.stringify({filename: "socialexp_" + subject_id, filedata: jsPsych.data.get().csv()}));
            xhr.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        done(); // proceed to next trial
                    }
                };
		}
	}

  //uncomment for testing with klara
	//timeline.push(saving_data)

	// Final thing participant sees
	var exp_end_screen = {
		type: 'html-keyboard-response',
		stimulus: function (){
		var sum_points = jsPsych.data.get().select('points').sum();	
		return [    "<p style='font-size: 25px'>Thank you!</p>" +
		      		"<p style='font-size: 25px'>You made " + sum_points + " points in the whole task </p>"
		]
		},
		trial_duration: 2000,
		response_ends_trial: false
	}

	timeline.push(exp_end_screen)


// use this function to save data async
	function saveData(name, data){
		var xhr = new XMLHttpRequest();
		xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
		xhr.setRequestHeader('Content-Type', 'application/json');
		xhr.send(JSON.stringify({filename: name, filedata: data}));
	}




jsPsych.init({
    timeline: timeline,
    on_interaction_data_update: function(data) {   // this funciton will log every time the participant does anything in their browser
		//jsPsych.data.addProperties(data);
		//console.log(JSON.stringify(data))
	},
    on_finish: function() {
	    jsPsych.data.addProperties({subject_id: subject_id});

	    var outfile = "socialexp_" + subject_id;

	    // to save to server
	    //saveData(outfile, jsPsych.data.get().csv());

	    // to save locally during testing
	    //jsPsych.data.get().localSave('json',outfile +'.json'); // when prompted save sile as csv
		jsPsych.data.get().localSave('csv',outfile +'.csv'); 
	    // to display after trial
	    jsPsych.data.displayData('csv');
    },
    exclusions: {   // this will exclude brosers which do not meet these minimum
    	min_width: 1280,
    	min_height: 577
    }
    });
  </script>
</html>


