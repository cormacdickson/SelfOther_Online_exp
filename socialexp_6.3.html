<!DOCTYPE html>
<html>
  <head>
  	<meta charset="UTF-8">
    <title>Social Experiment 6.3</title>
    <script src="jspsych-6.3.0/jspsych.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-rdk.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-RDM-pretrial.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-RDM-trial.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-instruction.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-RDM-instruction.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-RDM-training-fb.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-RDM-fb.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-preparing-schedules.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-fb-sequence.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-decision.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-decision-training.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-fb.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-main-training-fb.js"></script>
    <script src="RDM_training_schedule.js"></script>
    <script src="RDM_schedule.js"></script>
    <script src="RDM_pair_schedule_loading.js"></script>
    <script src="main_trial_schedule.js"></script>
    <script src="main_trial_training_schedule.js"></script>
    <script src="Porder_schedule.js"></script>
    <script src="rdmperf.js"></script>
    <link href="jspsych-6.3.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <link href="style.css" rel="stylesheet" type="text/css" />
  	</head>

  	<body>

  	</body>
  	<script>

    // hardcode important Variables //////////////
    var subject_id            = jsPsych.randomization.randomID(15); // generat a 15 digit subjet ID
    var colours               = ["rgb(127,201,127)","rgb(190,174,212)","rgb(253,192,134)","rgb(255,255,153)" ];
    var random_porder_index   = Math.floor(Math.random() * 1000);   // generate a random index and use this value to access one of the porder schedules
    var this_subjects_porder  = "Porder_"+random_porder_index;
    this_subjects_porder      = "Porder_1"     // until schedule is properly created just set it to porder 1
    var porder_sch            = eval(this_subjects_porder);
    var rdm_complete          = false; // dont think this does anything anymore
    var main_trial_count      = 0; // counter used to access correct value from porder schedule
    var this_subs_schedule; // will assign to a specific schedule later
    this_subs_schedule        = eval("main_sch_1"); // until schedule is properly created just set it to sch1
    var aperture_x_coords     = [(window.innerWidth/2-window.innerWidth/5), //the cordinates of each of the 4 aperturesopleft
    						                 (window.innerWidth/2-window.innerWidth/5),
                        	       (window.innerWidth/2+window.innerWidth/5), //topright
                        	       (window.innerWidth/2+window.innerWidth/5)];
     var aperture_y_coords   =[(window.innerHeight/2-window.innerHeight/4),
                        	     (window.innerHeight/2+window.innerHeight/4),
                        	     (window.innerHeight/2-window.innerHeight/4),
                        	     (window.innerHeight/2+window.innerHeight/4)];
    var RDM_pretrial_duration = 1500; // duration that the initials are displayed at the start of the exp
    var positions 			  	  = [0,1,2,3]; // positions of the players [topleft,bottomleft,topright,bottomright]
    var aperture_diam		  	  = 200; // diameter of the rdk apertures
    var bcgnd_color 		  	  = "black";
    var player_cols 		  	  = jsPsych.randomization.repeat(colours, 1); // assign colors randomly based on the four possible
    var total_dots 			  	  = [50,50,50,50]; //number of dots in each RDK
    var RDM_trial_duration 	  = 1000; // duration of the rdm
    var RDktype	  				    = 3; // type of rdk mechanism used
    var Aperturetype 	  		  = 1; // type of aperture used (1=circle)
    var Aperturenum       		= 4; // number of apertures
  	var RDM_training_fb_duration = 500; // duration that fb is displayed for during rdm task
  	var Main_fb_sequence_dur 	= [300,100,200,100,200,100,200,100,200,100,200,100,200,500]; // each timing corresponds to a portion of the feedback delay
  	var Main_decision_duration= 3000; //
  	var Main_decision_choices = ["arrowleft","arrowright"]; //responses only registered if they are listed here
    var Main_decision_fb_dur  = 1000;
    var Main_training_decision_fb_dur    = 2000;
    var trial_count           = 0; // used to check if this trial is a break trial
    var borders               = false;
    var RDM_performance       = 0;
    var num_RDM_trials        = 3;
    var closest_sch_value;  // global variable used to store the colosest accuracy value  to match scheduels
    var closest_sch_index; // global variable to store the closest sch index


	// intialise variables for rdm training so wecan determine coherance direction and the corresponding correct answer
	var correct_ans_right = "arrowright";
	var correct_ans_left = "arrowleft";
	var chosenValue;


  /* CREATE TIMELINE */
  var timeline = [];


  var enter_fullscreen = {
    type: "fullscreen",
    fullscreen_mode: true
  }
  //timeline.push(enter_fullscreen)

  var instructions_1 = {
         type: 'instructions',
         pages: function() {return [
             '<h1>Welcome to the group competition game!</h1>'+

             '<p>This game is about working together with another person in a team. Your team is playing</p>'+
             '<p>- against another team of two people. To Identify you, we will ask you to enter your </p>'+
             '<p>- initials on the next screen.</p>'+
             '<p>The game will take about 30 minutes and has two parts:</p>'+

             '<p>--> Part 1: Individual performance assessment(~5min) </br>--> Part 2: The group competition task<p>'+

             '<p></br>Press the arrow to procee to the next screen and enter you initials.</p>'

         ]},
         show_clickable_nav: true,
         button_label_previous: '',
         button_label_next: ''
  }

//  timeline.push(instructions_1)




///////////////////////////////////////////////////////////
//----------------Get players initials---------------------
////////////////////////////////////////////////////////////
var get_initials = {
  type: "survey-text",
  questions: [ {prompt: 'Please enter your initials in the box below:', required: true}],
  on_finish: function(data) {
        initials = data.response.Q0.toUpperCase();
        jsPsych.data.addProperties({ player: initials });
        return initials;
    }
}

var confirm_initials = {
  type: "survey-multi-choice",
  questions: [{
      prompt: function() {
        //var playerid   = jsPsych.data.getDataByTimelineNode('0.0-0.0').select('player').values[0];
        var playerid   = jsPsych.data.get().select('player').values[0];
        return 'Please confirm your initials are: ' +playerid+ '';
      },
      name: 'confirmInitials',
      options: ['Confirm', 'Re-enter initals'],
      required: true
  }],
};

var Get_ID_loop = {
    timeline: [get_initials,confirm_initials],
    loop_function: function(){
        var data = jsPsych.data.get().last(1).values()[0];
        if(jsPsych.pluginAPI.compareKeys(data.response.confirmInitials, 'Confirm')){
            return false;
        } else {
            return true;
        }
    }
}

//timeline.push(Get_ID_loop);



///////////////////////////////////////////////////////////
//----------------Show instructions for RDM---------------------
////////////////////////////////////////////////////////////
var rdm_instructions_1 = {
  // get the subjects initials
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
    return ;
  },
    type:"RDM-instruction",
    instr_num: -1, //
    screen_num: 0, //number of sscreens that participant has to flicjk through
    dectype: 2,
    outcomeEngage: 0,
    trial_duration: Main_decision_duration,
    response_ends_trial: true,
    choices: Main_decision_choices,
    number_of_apertures: Aperturenum,
    player_colours: player_cols,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: false,
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};
//timeline.push(rdm_instructions_1)

var rdm_instructions_2 = {
           type: 'instructions',
           pages: function() {return [

               '<h1>Part 1 - Individual performance assessment: Random dot motion task!</h1>'+

               '<p>We ask you to perform a “random dot motion” task, in which you will see <p>'+
               '<p>- dot motion clouds moving to the left or to the right at your position where your initials are.<p>'+
               '<p>Please press the “left” or “right” arrow button to indicate the correct direction.<p>'+

              '<p>Correct performance will be displayed as:</br><img src="images/fb_correct.png" width="40px" class="center"><p>'+

              '<p>Incorrect performance will be displayed as:</br><img src="images/fb_wrong.png" width="50px" class="center"><p>'+

              '<p></br>Note that you will have to respond very quickly after the dots have appeared, <p>'+
              '<p>- otherwise your performance will be counted as incorrect.<p>'+
              '<p>We will collect your peformance information when you do so.<p>'+

              '<p>Try it now! Press the right arrow to start.</p>'


           ]},
           show_clickable_nav: true,
           button_label_previous: '',
           button_label_next: ''
       }

 timeline.push(rdm_instructions_2)


/////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////
//		RDM Training
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////

// this node  shows 4 circular apertures with player ids
var RDM_pretrial = {
  // get the subjects initials
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
    return ;
  },
    type:"RDM-pretrial",
    player_colours: player_cols,
    trial_duration: RDM_pretrial_duration,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: borders,
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};

// this node is the training rdk trial its different from main only in the sequence it uses
var RDM_training_trial = {
    type:"RDM-trial",
    trial_duration: RDM_trial_duration,
    coherent_direction: function(){
    	chosenValue = Math.random() < 0.5 ? 0 : 180;
    	return chosenValue;
    },
    correct_choice: function(){
    	if (chosenValue == 0) {
    		return correct_ans_right
    	}else if (chosenValue == 180) {
    		return correct_ans_left
    		}
    },
    coherence: jsPsych.timelineVariable('coh'),
    RDK_type: RDktype, //Applied to all apertures if only one value
    aperture_type: Aperturetype, // circle
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: borders,
    player_colours: player_cols,
    number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};

// this node is the main rdk trial which displays the moving dots
var RDM_trial = {
    type:"RDM-trial",
    trial_duration: RDM_trial_duration,
    coherent_direction: function(){
      chosenValue = Math.random() < 0.5 ? 0 : 180;
      return chosenValue;
    },
    correct_choice: function(){
      if (chosenValue == 0) {
        return correct_ans_right
      }else if (chosenValue == 180) {
        return correct_ans_left
        }
    },
    coherence: jsPsych.timelineVariable('coh'),
    RDK_type: RDktype, //Applied to all apertures if only one value
    aperture_type: Aperturetype, // circle
    player_on:0, // index of the player to show rdk for [self,partner,op1,op2]
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: false,
    player_colours: player_cols,
    number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords,
    on_finish: function(){
      saveData(outfile, jsPsych.data.get().csv());
    }
};

// this node presents feedback on rdm choices
var RDM_training_fb = {
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
  },

    type:"RDM-training-fb",
    number_of_apertures: Aperturenum, //This needs to be set if more than one aperture
    trial_duration: RDM_training_fb_duration,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    player_colours: player_cols,
    aperture_type: Aperturetype, // circle
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: borders,
    feedback: function(){
      var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
      if(last_trial_correct){
        return 1;
      } else {
        return 0;
      }
    },
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};

// this node gives feedbback on rdk choice only if no answer was given
var RDM_fb = {
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
  },

    type:"RDM-fb",
    number_of_apertures: Aperturenum, //This needs to be set if more than one aperture
    trial_duration: RDM_training_fb_duration,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    player_colours: player_cols,
    aperture_type: Aperturetype, // circle
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: borders,
    feedback: function(){
      var last_response = jsPsych.data.get().last(1).values()[0].response;
      if(last_response == -1){
        return 2;
      } else {
        return 0;
      }
    },
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};

// additional trial if none of the previous responses were corect. it gets fed into the node
var RDM_training_ifnoneright_trial = {
    type:"RDM-trial",
    trial_duration: RDM_trial_duration,
    coherent_direction: function(){
    	chosenValue = Math.random() < 0.5 ? 0 : 180;
    	return chosenValue;
    },
    correct_choice: function(){
    	if (chosenValue == 0) {
    		return correct_ans_right
    	}else if (chosenValue == 180) {
    		return correct_ans_left
    		}
    },
    coherence: 	    0.512,
    RDK_type: 	    RDktype, //Applied to all apertures if only one value
    aperture_type:  Aperturetype, // circle
    player_position:positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border:         borders,
    player_colours: player_cols,
    number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};

// additional trial if none of the previous responses were corect. it gets fed into the node
var RDM_training_ifnonewrong_trial = {
    type:"RDM-trial",
    trial_duration: RDM_trial_duration,
    coherent_direction: function(){
    	chosenValue = Math.random() < 0.5 ? 0 : 180;
    	return chosenValue;
    },
    correct_choice: function(){
    	if (chosenValue == 0) {
    		return correct_ans_right
    	}else if (chosenValue == 180) {
    		return correct_ans_left
    		}
    },
    coherence: 0.0312,
    RDK_type: RDktype, //Applied to all apertures if only one value
    aperture_type: Aperturetype, // circle
    player_on:0, // index of the player to show rdk for [self,partner,op1,op2]
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: borders,
    player_colours: player_cols,
    number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};

// if none right we want to show two of additional trial sequences
var if_no_Right_node = {
	repetitions: 1,
    timeline: [RDM_pretrial,  RDM_training_ifnoneright_trial,  RDM_training_fb,  RDM_pretrial, RDM_training_ifnoneright_trial,  RDM_training_fb],
    conditional_function: function(){
        // get the data from the previous trial,
        // and check which key was pressed
        var sum_correct = jsPsych.data.get().select('correct').sum();
        if(sum_correct == 0){
            return true;
        } else {
            return false;
        }
    }
}

// if none wrong we want to show two of additional trial sequences
var if_no_Wrong_node = {
	repetitions:1,
    timeline: [RDM_pretrial,  RDM_training_ifnonewrong_trial,  RDM_training_fb,  RDM_pretrial, RDM_training_ifnonewrong_trial,  RDM_training_fb],
    conditional_function: function(){
        // get the data from the previous trial,
        // and check which key was pressed
        //var sum_incorrect = jsPsych.data.get().select({correct: false}).sum();
        var sum_correct = jsPsych.data.get().select('correct').sum();
        if(sum_correct == 4){
            return true;
        } else {
            return false;
        }
    }
}


///////////////////////////////////
// this is the rdm training block of 4 trials
//---------------------------------------------
var RDM_training_block = {
  timeline: [RDM_pretrial, RDM_training_trial,RDM_training_fb],
  timeline_variables: RDM_training_schedule,
  randomize_order:false
}
 timeline.push(RDM_training_block)

///////////////////////////////////
// this is a conditional block if any of the criteria are met ( none, right none wrong)
var RDM_training_if_block = {
  timeline: [if_no_Right_node,if_no_Wrong_node],
  //timeline_variables: RDM_training_schedule,
  randomize_order:false,
  repetitions:1
}
  timeline.push(RDM_training_if_block)
//---------------------------------------------
///------------ Training Ends ------------///
//----------------------------------------------



//---------------------------------------------
///------------ RDM task begins ------------///
//----------------------------------------------
var instructions_3 = {
       type: 'instructions',
       pages: function() {return [
           '<h1>Part1 – Individual performance assessment: Random dot motion task</h1>'+

           '<p>We ask you to perform a “random dot motion” task, in which you will </p>'+
           '<p>- see dot motion clouds moving to the left or to the right at your position where your initials are.<p>'+
           '<p>Please press the “left” or “right” arrow button to indicate the correct direction.<p>'+

          '<p>Correct performance will be displayed as:</br><img src="images/fb_correct.png" width="30px" class="center"><p>'+

          '<p>Incorrect performance will be displayed as:</br><img src="images/fb_wrong.png" width="70px" class="center"><p>'+

           '<p></br>- Note that you will have to respond very quickly after the dots have appeared, otherwise you <p>'+
           '<p>- will see a “Miss” on the screen and the performance will be counted as incorrect.<p>'+
           '<p>We will collect your performance information when you do so.<p>'+

           '<p></br>Try it now! Press right arrow button to start.</p>'

       ]},
       show_clickable_nav: true,
       button_label_previous: '',
       button_label_next: ''
}

 timeline.push(instructions_3)


 // useful node to insert if you want to check the data output from a given trial
 var show_data = {
     type: "html-button-response",
     stimulus: function() {
       var trial_data = jsPsych.data.getLastTrialData().values();
       var trial_json = JSON.stringify(trial_data, null, 2);
       return `<p style="margin-bottom:0px;"><strong>Trial data:</strong></p>
         <pre style="margin-top:0px;text-align:left;">${trial_json}</pre>`;
     },
     choices: ['Repeat demo']
   };


var RDM_block = {
  timeline: [RDM_pretrial, RDM_trial,RDM_fb],
  timeline_variables: RDM_schedule,
  randomize_order:true,
  on_timeline_start: function(){
    //console.log(RDM_block.timeline_variables)
  },
  on_timeline_finish: function(){
    RDM_performance = jsPsych.data.get().filter({trial_type:"RDM-trial", correct:true}).count();
    RDM_performance = RDM_performance/num_RDM_trials;

    // pair schedules
    closest_sch_value = rdmperf.reduce((a, b) => {
    return Math.abs(b - RDM_performance) < Math.abs(a - RDM_performance) ? b : a;
    });
    // now get the index of this schedule
    closest_sch_index = rdmperf.indexOf(closest_sch_value);
    this_subs_schedule = eval("main_sch_1");
    rdm_complete = true;
    //this_subs_schedule = eval("main_sch_"+ closest_sch_index);




  }
}

timeline.push(RDM_block)


//---------------------------------------------
///------------ RDM task ends ------------///
//----------------------------------------------


//---------------------------------------------
///------------ interlude: pairing schedules ------------///
//----------------------------------------------

// tell participants we are pairing schedules
var pair_schedules = {
  type: 'preparing-schedules',
  response_ends_trial: false,
  background_color:bcgnd_color
}

timeline.push(pair_schedules)



//---------------------------------------------
///------------ Main trainin gbegins ------------///
//----------------------------------------------
var instructions_4 = {
           type: 'instructions',
           pages: function() {return [

              '<h1>Part 2 –Group competition task </h1>'+
              '<p><br>In the group competition task, you will see your performance from part 1 and<p>'+
               '<p>also performance of the three other players (performance phase). <p>'+
               '<p>We ask you to make decisions about these performances (decision phase). By making good<p>'+
               '<p>decisions, you can collect points. The goal of part 2 is to collect as many points as possible.<p>'+
              '<p><br>During the performance phase:<p>'+
              '<p><br>During the performance phase:<p>'+
              '<p>You will see performances of each player on every round.<p>'+
              '<p>Correct performance will be displayed as:</br><img src="images/fb_correct.png" width="100px" class="center"><p>'+
              '<p>Incorrect performance will be displayed as:</br><img src="images/fb_wrong.png" width="150px" class="center"><p>'+
			        '<p>We will now show you how the performance phase looks like. Press <right arrow> button to start.<p>'

           ]},
           show_clickable_nav: true,
           button_label_previous: '',
           button_label_next: ''
       }

 timeline.push(instructions_4)




/// this node presents the feebcak for each particiapant in order using the set practicce sequence
var main_practice_sequence = {
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
    return ;
  },
  type:"main-fb-sequence",
  //trial_duration: 10000,
  trial_duration: Main_fb_sequence_dur,
  coherent_direction: 0,  //// how do we want to assign this , same for each pplayer?
  S_perf : [0,1,0,1,0,1],
  P_perf : [0,1,0,1,0,1],
  O1_perf : [0,1,0,1,0,1],
  O2_perf : [0,1,0,1,0,1],
  coherence: 0.5,
  player_position: positions,
  p_order: [0,1,2,3], // index of the player to show rdk for [self,partner,op1,op2]
  aperture_width: aperture_diam, //Applied to all apertures if only one value
  border: false,
  player_colours: player_cols,
  number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
  aperture_center_x: aperture_x_coords,
  aperture_center_y: aperture_y_coords
};
timeline.push(main_practice_sequence)



// This is the first main decision ( note it needs to be seperate because it relies on dec_num to select the create decision from schedule)
var main_instructions_1 = {
  // get the subjects initials
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;

    var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
    trial.previous_dot_positions = dotArray3d;
    //var test = jsPsych.data.getLastTrialData().select('aperture_center_x').values[1];
    return ;
  },
    type:"main-instruction",
    instr_num: 0, // first or second decison
    screen_num: 2, //number of sscreens that participant has to flicjk through
    dectype: 2,
    outcomeEngage: 0,
    trial_duration: Main_decision_duration,
    response_ends_trial: true,
    choices: Main_decision_choices,
    player_colours: player_cols,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: false,
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};


var main_instructions_2 = {
  // get the subjects initials
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;

    var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
    trial.previous_dot_positions = dotArray3d;
    //var test = jsPsych.data.getLastTrialData().select('aperture_center_x').values[1];
    return ;
  },
    type:"main-instruction",
    instr_num: 1, // first or second decison
    screen_num: 0, //number of sscreens that participant has to flicjk through
    dectype: 2,
    outcomeEngage: 0,
    trial_duration: Main_decision_duration,
    response_ends_trial: true,
    choices: Main_decision_choices,
    player_colours: player_cols,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: false,
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};

var main_instructions_3 = {
  // get the subjects initials
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;

    var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
    trial.previous_dot_positions = dotArray3d;
    //var test = jsPsych.data.getLastTrialData().select('aperture_center_x').values[1];
    return ;
    },
    type:"main-instruction",
    instr_num: 2, // first or second decison
    screen_num: 0, //number of sscreens that participant has to flicjk through
    dectype: 3,
    outcomeEngage: 0,
    trial_duration: Main_decision_duration,
    response_ends_trial: true,
    choices: Main_decision_choices,
    player_colours: player_cols,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: false,
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};

timeline.push(main_instructions_1)
timeline.push(main_practice_sequence)
timeline.push(main_instructions_2)
timeline.push(main_instructions_3)

var main_instructions_4 = {
       type: 'instructions',
       pages: function() {return [
         '<h1>Part 2 –The group competition task </h1>'+

         '<p>Notes:</p>'+

         '<p> - Try to remember the performance from everyone on every round</p>'+

         '<p> - We will ask you to compare the performance between one player (i.e., you or your partner) from your team and one player (i.e., O1 or O2) from the other team,</p>' +


         '<p> - You can get just as many points from decisions based on your partner’s performance as your own! What matters is which team was better!</p>'+

         '<p><br> - To collect as many points as possible, you should: <br>'+

         'press <left arrow> key to engage in competition if the one from your team was better than the other one;'+
         '<br>press <right arrow> key to avoid competition if the one from your team was worse than the other one.'+

         '<p><br> - Let’s do a practice round, in which we will show whether your decision is correct or not (?). Press <right arrow> key to start when you are ready. </p>'


       ]},
       show_clickable_nav: true,
       button_label_previous: '',
       button_label_next: ''
}

timeline.push(main_instructions_4)


// draw feedback boxes with text feedback overlayed
var main_training_fb = {
	on_start: function(trial){
	var p1   = jsPsych.data.get().select('player').values[0];
	trial.player1 = p1;

  var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
  trial.previous_dot_positions = dotArray3d;
	},
    dec_num: 1, // first or second decison
    dectype: jsPsych.timelineVariable('dectype'),
    type:"main-training-fb",
    number_of_apertures: Aperturenum, //This needs to be set if more than one aperture
    trial_duration: Main_training_decision_fb_dur,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    player_colours: player_cols,
    aperture_type: Aperturetype, // circle
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: false,
    outcomeEngage: jsPsych.timelineVariable('outcomeEngage'),
    engaged: function(){
      var last_resp = jsPsych.data.get().last(1).values()[0].response;
      if(jsPsych.pluginAPI.compareKeys(last_resp, 'arrowleft')){
        return 0;
      } else if (jsPsych.pluginAPI.compareKeys(last_resp, 'arrowright')) {
        return 1
      }
    },
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};






/// this node presents the performance feebcak from the rdm task for each particiapant in order using the schedules
var main_fb_sequence = {
  on_start: function(trial){
    // get the players name
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;

    // get the values from the schedule assigned to this player
    trial.p_order = Object.values(porder_sch[main_trial_count]); // access the actual values
    trial.S_perf = Object.values(this_subs_schedule[main_trial_count].S_perf);
    trial.P_perf = Object.values(this_subs_schedule[main_trial_count].P_perf);
    trial.O1_perf = Object.values(this_subs_schedule[main_trial_count].O1_perf);
    trial.O2_perf = Object.values(this_subs_schedule[main_trial_count].O2_perf);

    return ;
  },
  type:"main-fb-sequence",
  //trial_duration: 10000,
  trial_duration: Main_fb_sequence_dur,
  coherent_direction: [0,0,0,0],  //// how do we want to assign this , same for each pplayer? ANS needs to be updated to be randomly assigned
  S_perf : jsPsych.timelineVariable('S_perf'),//[0,1,0,1,0,1],
  P_perf : jsPsych.timelineVariable('P_perf'),//[0,1,0,1,0,1],
  O1_perf : jsPsych.timelineVariable('O1_perf'),//[0,1,0,1,0,1],
  O2_perf : jsPsych.timelineVariable('O2_perf'),//[0,1,0,1,0,1],
  coherence: 0.75,
  player_position: positions,
  //p_order: this_subjects_porder, // index of the player to show rdk for [self,partner,op1,op2]
  aperture_width: aperture_diam, //Applied to all apertures if only one value
  border: false,
  player_colours: player_cols,
  number_of_dots: total_dots, //Different parameter for each aperture. Array length must equal number_of_apertures
  aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};


// This is the first main decision ( note it needs to be seperate because it relies on dec_num to select the create decision from schedule)
var main_decision_practice = {
  // get the subjects initials
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;

    var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
    trial.previous_dot_positions = dotArray3d;
    //var test = jsPsych.data.getLastTrialData().select('aperture_center_x').values[1];
    return ;
    },
    type:"main-decision-training",
              //    dec_num: 0, // first or second decison
    dectype: jsPsych.timelineVariable('dectype'),
    outcomeEngage: jsPsych.timelineVariable('outcomeEngage'),
    trial_duration: Main_decision_duration,
    response_ends_trial: true,
    choices: Main_decision_choices,
    player_colours: player_cols,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: false,
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};

// This is the first main decision ( note it needs to be seperate in the main task because we relies on dec_num to select the create decision from schedule - (this is not the case in main training)
var main_decision_1 = {
  // get the subjects initials
  on_start: function(trial){
    // get the players name
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;

    // get the values from the schedule assigned to this player
    trial.dectype = Object.values(this_subs_schedule[main_trial_count].dectype);
    trial.outcomeEngage = Object.values(this_subs_schedule[main_trial_count].outcomeEngage);

      // take the array of dots from the last screen to keep display consistant
    var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
    trial.previous_dot_positions = dotArray3d;
    //var test = jsPsych.data.getLastTrialData().select('aperture_center_x').values[1];
    return ;
  },
    type:"main-decision",
    dec_num: 0, // first or second decison
    //dectype: jsPsych.timelineVariable('dectype'),
    //outcomeEngage: jsPsych.timelineVariable('outcomeEngage'),
    trial_duration: Main_decision_duration,
    response_ends_trial: true,
    choices: Main_decision_choices,
    player_colours: player_cols,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: false,
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};




var main_decision_2 = {
  // get the subjects initials
  on_start: function(trial){
    // get the players name
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;

    // get the values from the schedule assigned to this player
    trial.dectype = Object.values(this_subs_schedule[main_trial_count].dectype);
    trial.outcomeEngage = Object.values(this_subs_schedule[main_trial_count].outcomeEngage);

    // increment the trial counter ( this only happens in this trial node but applies to all nodes in this timeline)
    main_trial_count++; // increment trial counter

    // take the array of dots from the last screen to keep display consistant
    var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
    trial.previous_dot_positions = dotArray3d;
    return ;
  },
    type:"main-decision",
    dec_num: 1, // first or second decison
    //dectype: jsPsych.timelineVariable('dectype'),
    //outcomeEngage: jsPsych.timelineVariable('outcomeEngage'),
    trial_duration: Main_decision_duration,
    response_ends_trial: true,
    choices: Main_decision_choices,
    player_colours: player_cols,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: false,
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};


// draw feedback boxes
var main_fb = {
  on_start: function(trial){
    var p1   = jsPsych.data.get().select('player').values[0];
    trial.player1 = p1;
    var dotArray3d = jsPsych.data.get().select('trial_3d_dot_array');
    trial.previous_dot_positions = dotArray3d;
  },
    type:"main-fb",
    number_of_apertures: Aperturenum, //This needs to be set if more than one aperture
    trial_duration: Main_decision_fb_dur,
    RDK_type: RDktype, //Applied to all apertures if only one value
    player_position: positions,
    player_colours: player_cols,
    aperture_type: Aperturetype, // circle
    aperture_width: aperture_diam, //Applied to all apertures if only one value
    border: false,
    feedback: function(){
      var last_resp = jsPsych.data.get().last(1).values()[0].response;
      if(jsPsych.pluginAPI.compareKeys(last_resp, 'arrowleft')){
        return 0;
      } else if (jsPsych.pluginAPI.compareKeys(last_resp, 'arrowright')) {
        return 1
      }
    },
    background_color: bcgnd_color,
    border_color: player_cols,
    aperture_center_x: aperture_x_coords,
    aperture_center_y: aperture_y_coords
};



// create timeline for the main block
var main_training_block = {
  timeline: [ main_decision_practice, main_training_fb],
  timeline_variables: main_trial_training_schedule,
  //timeline_variables: Porder, //"Porder_"+subject_id,
  randomize_order:false,
  on_timeline_start: function(){
    //console.log(main_training_block);
  }
}

timeline.push(main_practice_sequence) // only show the sequence once
timeline.push(main_training_block)    // then ask 4 questions

var main_instructions_5 = {
       type: 'instructions',
       pages: function() {return [
         '<h1>Part 2 –The group competition task </h1>'+

         '<p>Well done! We now ask you to do this task for approximately 16 minutes. </p>'+

         '<p>Try to keep track of everyone’s performance as well as you can and make accurate decisions.</p>'+

         '<p>After every performance phase, you only need to do two decisions (one after the other).</p>' +

         '<p>The decisions always refer to the performances you have seen just before. These performances will </p>'+

         '<p>- be NEW every time you see them. This will be different to the practical round just now and it will  </p>'+

         '<p>- be a real challenge to keep track of the information!</p>'+

         '<p>Your decision outcome will not be shown on every round, but you will know your cumulative points when you finish one session. </p>'+

         '<p></br>If you are ready, press <right arrow> key to start.</p>'

       ]},
       show_clickable_nav: true,
       button_label_previous: '',
       button_label_next: ''
}

timeline.push(main_instructions_5)




var break_trial = {
  type: 'html-keyboard-response',
  stimulus:  "<p style='font-size: 25px'>Time to take a break!</p>" +
          "<p style='font-size: 25px'>Take a rest for about a minute. Then, Continue by pressing 'C'</p>",
  choices: "c"
};

var break_conditional = {
  timeline: [break_trial],
  conditional_function: function() {
    // increment trial count - in first run through the timeline variables procedure, trial_count will be equal to 1
    trial_count++;
    if (trial_count % 16 == 0) {
      // if the trial count is divisible by 96, then run the break trial
      return true;
    } else {
      // otherwise skip the break trial
      return false;
    }
  }
};



// create timeline for the main block
var main_block = {
  timeline: [break_conditional,main_fb_sequence,main_decision_1, main_fb, main_decision_2, main_fb],
  timeline_variables : main_sch_2, // Now give the block an empty set of arrays of length = number of trials we warrant
  // the paramaters we want are assigned dynamically in the
  on_timeline_start: function(){
    main_trial_count = 0;
  }
}


timeline.push(main_block)



function saveData(name, data){
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.send(JSON.stringify({filename: name, filedata: data}));
}





// select all trials
// var all_data = jsPsych.data.get();

// get csv representation of data and log to console
// console.log(all_data.csv());


/* start the experiment */
//jatos.onLoad(function() {

/*
      on_finish: function() {
        //jsPsych.data.displayData('csv');
        var resultJson = jsPsych.data.get().csv();
      jatos.submitResultData(resultJson, jatos.endStudy);
      }
      */

jsPsych.init({
      timeline: timeline,
      on_finish: function() {
        saveData(outfile, jsPsych.data.get().csv());
        jsPsych.data.displayData('csv');
    }
    });
  </script>
</html>
